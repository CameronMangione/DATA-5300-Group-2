---
title: "Group Project 1"
author: "cameronjosephblackmangione"
output: html_document
date: "2025-10-26"
---
```{r}
library(dplyr)
library(ggplot2)
library(nycflights13)
library(readr)
library(curl)
library(tidyr)
library(fivethirtyeight)
library(tidyverse)
library(resampledata3)
library(moderndive)
library(readxl)
```
## Common Permutation Test Function For Two-Sided Mean Test
```{r}
perm_test <- function(group_one,group_two,n_perm = 10^4-1){
#two sided perm test calcuation
#group1, group2: Numeric vectors for the two groups
#n_perm: Number of permutation iterations
  
  #observed mean difference
  observed <- mean(group_one) - mean(group_two)

  groups_combined <- c(group_one,group_two)

  #sample.size = the number of observations in our sample
  sample.size <- length(groups_combined)

  #group.1.size = the number of observations in the first group
  group.1.size = length(group_one)

  #create a blank vector to store the simulation results
  result <- numeric(n_perm)

  #use a for loop to cycle through values of i ranging from 1 to n_perm
  for(i in 1:n_perm)
  {
    index <- sample(sample.size, size=group.1.size, replace = FALSE)

    result[i] <- mean(groups_combined[index]) - 
                mean(groups_combined[-index])
  }
  
  ggplot(data = tibble(result), aes(x = result))+
    geom_histogram() + 
    geom_vline(xintercept = observed, color = "red")
  
  p_value <- (sum(abs(result) >= abs(observed)) + 1) / (N + 1)

  return (p_value)
}
```


```{r}
weather
```
```{r}
flights
```
```{r}
flights_ua <- flights %>%
  filter(carrier == "UA") %>%
  filter(!is.na(dep_delay))
glimpse(flights_ua)
```
```{r}
weather_clean <- weather %>%
  filter(!is.na(wind_speed)) %>%
  filter(!is.na(temp)) %>%
  filter(!is.na(visib)) %>%
  filter(!is.na(precip))
glimpse(weather_clean)
```
```{r}
merged <- flights_ua %>%
  inner_join(weather_clean, by = c("year", "month", "day", "hour", "origin"))
glimpse(merged)
```

```{r}
merged <- merged %>%
  mutate(late = dep_delay > 0)
glimpse(merged)
```

```{r}
ggplot(data = merged, aes(x = temp, y = dep_delay))+
  geom_point(alpha = 0.7)
```
```{r}
ggplot(data = merged, aes(x = wind_speed, y = dep_delay))+
  geom_point(alpha = 0.7)
```
```{r}
ggplot(data = merged, aes(x = precip, y = dep_delay))+
  geom_point(alpha = 0.7)
```
```{r}
ggplot(data = merged, aes(x = visib, y = dep_delay))+
  geom_point(alpha = 0.7)
```

### Cameron worked on the precipitation data.
```{r}
merged_precip <- merged %>%
  filter(precip > 0)
glimpse(merged_precip)
```

```{r}
observed <- mean(merged_precip$precip[merged_precip$late == TRUE]) - mean(merged_precip$precip[merged_precip$late == FALSE])

N <- 10^4-1

sample.size = nrow(merged_precip)

group.1.size = nrow(merged_precip[merged_precip$late == TRUE,])

result <- numeric(N)

for (i in 1:N)
{
  index = sample(sample.size, size = group.1.size, replace=FALSE)
  result[i] = mean(merged_precip$precip[index]) - mean(merged_precip$precip[-index])
}

ggplot(data = tibble(result), aes(x = result))+
  geom_histogram() + 
  geom_vline(xintercept = observed, color = "red")

observed
2*(sum(result >= observed) +1) / (N+1)
```

```{r}
merged_visib <- merged %>%
  filter(visib < 10)
glimpse(merged_visib)
```

```{r}
observed <- mean(merged_visib$visib[merged_visib$late == TRUE]) - mean(merged_visib$visib[merged_visib$late == FALSE])

N <- 10^4-1

sample.size = nrow(merged_visib)

group.1.size = nrow(merged_visib[merged_visib$late == TRUE,])

result <- numeric(N)

for (i in 1:N)
{
  index = sample(sample.size, size = group.1.size, replace=FALSE)
  result[i] = mean(merged_visib$visib[index]) - mean(merged_visib$visib[-index])
}

ggplot(data = tibble(result), aes(x = result))+
  geom_histogram() + 
  geom_vline(xintercept = observed, color = "red")

observed
2*(sum(abs(result) >= observed) +1) / (N+1)
```
### Ahrial worked on time of day
```{r}
average_delay_by_hour <- merged %>%
      group_by(hour) %>%
      summarize(avg_dep_delay = mean(dep_delay, na.rm = TRUE))

ggplot(average_delay_by_hour, aes(x = hour, y = avg_dep_delay)) +
      geom_line() +
      geom_point() +
      labs(title = "Average Departure Delay by Hour of Day",
           x = "Hour of Day",
           y = "Average Departure Delay (minutes)")
flights_hourly <- merged %>%
  group_by(hour) %>%
  summarize(
    total_flights = n(),
    dc_count = sum(late),
    dc_percentage = (dc_count / total_flights) * 100)
flights_hourly_dc

ggplot(data = flights_hourly, aes(x = hour, y = total_flights)) +
  geom_line() +
  labs(title = "Total Flights by Hour",
       x = "Scheduled Departure Hour",
       y = "Number of Flights")

ggplot(data = flights_hourly, aes(x = hour, y = dc_percentage)) +
  geom_line() +
  labs(title = "Percentage of Late Flights by Hour",
       x = "Scheduled Departure Hour",
       y = "Percentage of Late Flights")
```
There is an inflection point around noon so we will split the data between morning and evening.

```{r}
# time of day
# compare evening vs day

observed <- mean(fwj$dep_delay[fwj$dep_time<= 1200]) -
mean(fwj$dep_delay[fwj$dep_time>1200])

#N = number of simulations we will use
N <- 10^3-1

#sample.size = the number of observations in our sample
sample.size = nrow(fwj)

#group.1.size = the number of observations in the first group
group.1.size = nrow(fwj[fwj$dep_time<=1200,])

#create a blank vector to store the simulation results
result <- numeric(N)

#use a for loop to cycle through values of i ranging from 1 to N
for(i in 1:N)
{
  index = sample(sample.size, size=group.1.size, replace = FALSE)

  #calculate and store the difference in
  #mean dep_delay between the index and non-index groups
  result[i] = mean(fwj$dep_delay[index]) - mean(fwj$dep_delay[-index])
}

#plot a histogram of the simulated differences
#add a vertical line at the observed difference
ggplot(data=tibble(result), mapping = aes(x=result)) +
  geom_histogram() +
  geom_vline(xintercept = observed, color = "red")

#Calculate the p-value
pvalue <-(sum(result >= observed) + 1) / (N + 1)
pvalue

if (pvalue <= 0.05) {
  print("Reject the null hypothesis.")
} else {
  print("Fail to reject the null hypothesis.")
}
```

```{r}
observed <- mean(merged$temp[merged$late == TRUE]) - mean(merged$temp[merged$late == FALSE])

N <- 10^4-1

sample.size = nrow(merged)

group.1.size = nrow(merged[merged$late == TRUE,])

result <- numeric(N)

for (i in 1:N)
{
  index = sample(sample.size, size = group.1.size, replace=FALSE)
  result[i] = mean(merged$temp[index]) - mean(merged$temp[-index])
}

ggplot(data = tibble(result), aes(x = result))+
  geom_histogram() + 
  geom_vline(xintercept = observed, color = "red")

observed
2*(sum(result >= observed) +1) / (N+1)
```
```{r}
observed <- mean(merged$wind_speed[merged$late == TRUE]) - mean(merged$wind_speed[merged$late == FALSE])

N <- 10^4-1

sample.size = nrow(merged)

group.1.size = nrow(merged[merged$late == TRUE,])

result <- numeric(N)

for (i in 1:N)
{
  index = sample(sample.size, size = group.1.size, replace=FALSE)
  result[i] = mean(merged$wind_speed[index]) - mean(merged$wind_speed[-index])
}



observed
2*(sum(result >= observed) +1) / (N+1)
```

### Time of year (Jack)

#### Analyze time of year data
Analyzing number of late flights by month
```{r}


ggplot(data = merged, aes(x = factor(month), fill = late)) +
  geom_bar() +
  labs(title = "Number of Late Flights by Month",
       x = "Month",
       y = "Number of Late Flights")
```
Average delays for a flight per month
```{r}

merged <- merged %>%
  mutate(dep_delay_adj =ifelse(dep_delay > 0, dep_delay, 0))  #adjust dep_delay to 0 

avg_delay_by_month <- merged %>%
  group_by(month) %>%
  summarise(avg_delay = mean(dep_delay_adj, na.rm = TRUE))

# Then, plot
ggplot(data = avg_delay_by_month, aes(x = factor(month), y = avg_delay)) +
  geom_col(fill = "steelblue") +
  labs(title = "Average Departure Delay by Month",
       x = "Month",
       y = "Average Delay (minutes)")
```

From the above charts, it looks like summer has the most delays. My hypothesis is that summer average delays differ from other seasons.
#### Discretionize time of year (summer and other)

```{r}
merged <- merged %>%
  mutate(summerLabel = ifelse(month %in% c(6, 7, 8), "Summer Months", "Other Months"))
  
```


```{r}
avg_delay_by_summer_and_other <- merged %>%
  group_by(summerLabel) %>%
  summarise(avg_delay = mean(dep_delay_adj, na.rm = TRUE))
ggplot(data = avg_delay_by_summer_and_other, aes(x = summerLabel, y = avg_delay, fill = summerLabel)) +
  geom_col() +
  labs(title = "Average Delay: Summer vs. Other Months",
       x = "Time of Year",
       y = "Average Departure Delay (minutes)")

```


#### Summer late flights permutation test
```{r}
# Hypothesis
# h.0 = flight_delays.summer == flight_delays.other  (no difference between carrier delays)
# h.alt = flight_delays.winter != flight_delays.other

group1 <- merged$dep_delay_adj[merged$summerLabel == "Summer Months"]
group2 <- merged$dep_delay_adj[merged$summerLabel != "Summer Months"]
pvalue <- perm_test(group1,group2)


if (pvalue < 0.05) {
  cat("The p-value is", format(pvalue, scientific = FALSE), 
      "- Since this is below 0.05, we reject the null hypothesis.\n")
} else {
  cat("The p-value is", format(pvalue, scientific = FALSE), 
      "- Since this is above 0.05, we fail to reject the null hypothesis.\n")
}
```

### Jacob worked on the temperature and wind speed data.

#### Temperature Summary Statistics 
```{r}
summary_temp <- merged %>%
  summarize(mean = mean(temp, na.rm = TRUE),
            std_dev = sd(temp, na.rm = TRUE),
            min = min(temp, na.rm = TRUE),
            max = max(temp, na.rm = TRUE))
summary_temp
```

#### Permutation test for relationship between temperature and delays 
```{r}
observed <- mean(merged$temp[merged$late == TRUE]) - mean(merged$temp[merged$late == FALSE])

N <- 10^4-1

sample.size = nrow(merged)

group.1.size = nrow(merged[merged$late == TRUE,])

result <- numeric(N)

for (i in 1:N)
{
  index = sample(sample.size, size = group.1.size, replace=FALSE)
  result[i] = mean(merged$temp[index]) - mean(merged$temp[-index])
}

ggplot(data = tibble(result), aes(x = result))+
  geom_histogram() + 
  geom_vline(xintercept = observed, color = "red")

observed
2*(sum(result >= observed) +1) / (N+1)
```
#### Average Departure Delays vs. Temperature Graph

```{r}
merged <- merged %>%
  mutate(dep_delay_adj = ifelse(dep_delay > 0, dep_delay, 0))

avg_delay_by_temp <- merged %>%
  group_by(temp) %>%
  summarize(avg_delay = mean(dep_delay_adj, na.rm = TRUE))

ggplot(data = avg_delay_by_temp, aes(x = temp, y = avg_delay)) +
  geom_col(fill = "steelblue") +
  labs(title = "Average Departure Delay by Temperature",
       x = "Temperature (F)",
       y = "Average Delay (minutes)")
```

#### Wind Speed Summary Statistics 

```{r}
summary_wind_speed <- merged %>%
  summarize(mean = mean(wind_speed, na.rm = TRUE),
            std_dev = sd(wind_speed, na.rm = TRUE),
            min = min(wind_speed, na.rm = TRUE),
            max = max(wind_speed, na.rm = TRUE))
summary_wind_speed
```
#### Histogram of distribution of wind speed 

```{r}
ggplot(data = merged, mapping = aes(x = wind_speed)) +
  geom_histogram(bins=40, color="white", fill="cornflowerblue")
```

#### Permutation test for relationship between wind speed and delays 
```{r}
observed <- mean(merged$wind_speed[merged$late == TRUE]) - mean(merged$wind_speed[merged$late == FALSE])

N <- 10^4-1

sample.size = nrow(merged)

group.1.size = nrow(merged[merged$late == TRUE,])

result <- numeric(N)

for (i in 1:N)
{
  index = sample(sample.size, size = group.1.size, replace=FALSE)
  result[i] = mean(merged$wind_speed[index]) - mean(merged$wind_speed[-index])
}

ggplot(data = tibble(result), aes(x = result))+
  geom_histogram() + 
  geom_vline(xintercept = observed, color = "red")

observed
2*(sum(result >= observed) +1) / (N+1)
```

#### Average Departure Delays vs. Wind Speed Graph

```{r}
merged <- merged %>%
  mutate(dep_delay_adj = ifelse(dep_delay > 0, dep_delay, 0))

avg_delay_by_wind_speed <- merged %>%
  group_by(wind_speed) %>%
  summarize(avg_delay = mean(dep_delay_adj, na.rm = TRUE))

ggplot(data = avg_delay_by_wind_speed, aes(x = wind_speed, y = avg_delay)) +
  geom_col(fill = "steelblue") +
  labs(title = "Average Departure Delay by Wind Speed",
       x = "Wind Speed (miles per hour)",
       y = "Average Delay (minutes)")
```
### Visibility (jack)

#### Analyze time of year data
Analyzing number of late flights by month
```{r}
ggplot(data = merged, aes(x = visib, fill = late)) +
  geom_bar() +
  labs(title = "Number of Late Flights by visiblity",
       x = "Visibility (Miles)",
       y = "Number of Late Flights")
```
```{r}
ggplot(data = merged, aes(x = visib, fill = late)) +
  geom_bar() +
  labs(title = "Number of Late Flights by visiblity",
       x = "Visibility (Miles)",
       y = "Number of Late Flights")
```

```{r}

merged <- merged %>%
  mutate(dep_delay_adj =ifelse(dep_delay > 0, dep_delay, 0))  #adjust dep_delay to 0 when no delay 

avg_delay_by_visibilty <- merged %>%
  group_by(visib) %>%
  summarise(avg_delay = mean(dep_delay_adj, na.rm = TRUE))

# Then, plot
ggplot(data = avg_delay_by_visibilty, aes(x = factor(visib), y = avg_delay)) +
  geom_col(fill = "steelblue") +
  labs(title = "Average Departure Delay by Visibility (Miles)",
       x = "Visibility (Miles)",
       y = "Average Delay (minutes)")

```
Based on IFR low visibility is less than 3 miles
#### Discretionize visibility (low, normal)

```{r}
merged <- merged %>%
  mutate(visibilityLabel = ifelse(visib <=3, "Low Visibility", "Normal Visibility"))
```

```{r}
avg_delay_by_visibility <- merged %>%
  group_by(visibilityLabel) %>%
  summarise(avg_delay = mean(dep_delay_adj, na.rm = TRUE))
ggplot(data = avg_delay_by_visibility, aes(x = visibilityLabel, y = avg_delay, fill = visibilityLabel)) +
  geom_col() +
  labs(title = "Average Delay: Low Visibility vs Normal Visibility",
       x = "Visibility",
       y = "Average Departure Delay (minutes)")

```
#### Visibility flights permutation test
```{r}
# Hypothesis
# h.0 = flight_delays.low_visibility == flight_delays.normal_visibility  (no difference between carrier delays)
# h.alt = flight_delays.low_visibility != flight_delays.normal_visibility

group1 <- merged$dep_delay_adj[merged$visibilityLabel == "Low Visibility"]
group2 <- merged$dep_delay_adj[merged$visibilityLabel != "Low Visibility"]
pvalue <- perm_test(group1,group2)


if (pvalue < 0.05) {
  cat("The p-value is", format(pvalue, scientific = FALSE), 
      "- Since this is below 0.05, we reject the null hypothesis.\n")
} else {
  cat("The p-value is", format(pvalue, scientific = FALSE), 
      "- Since this is above 0.05, we fail to reject the null hypothesis.\n")
}


```
